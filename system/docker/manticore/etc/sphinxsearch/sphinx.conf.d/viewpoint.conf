#!/bin/sh
set -eu
cat <<EOF

#################
# this index's, sole purpose is to run updates. So that the real "viewpoint" index can connect to replica/slave

source viewpoint_master : db_master
{
        sql_query_pre           = REPLACE INTO sph_counter SELECT 'viewpoint', MAX(gridimage_id)-1000,'$HOSTNAME' as server_id, NOW() FROM gridimage_search

        #something really trivial, but got most compatiblity, return a text field. Never searched, so doesnt matter what contains
        # the 4 seconds, is HOPEFULLY to give the slave time to catch up.
        sql_query = SELECT gridimage_id,title,sleep(4) AS dummy FROM gridimage_search LIMIT 1
}

#################

source viewpoint_main : db_slave {

        sql_query_pre           = SET CHARACTER SET 'utf8'
        sql_query_pre           = SET SESSION query_cache_type=OFF
        sql_query_pre           = SET SESSION group_concat_max_len = 100000
	sql_query_pre           = SET SESSION max_statement_time = 600

	## Get a global lock so that only one manticore instance can index at a time. Even if lock expires we've somewhat desynced the various instances
	sql_query_pre           = SELECT GET_LOCK('viewpoint',500+ROUND(RAND()*100))
	sql_query_post          = SELECT RELEASE_LOCK('viewpoint')

	sql_query_range         = SELECT 1,max_doc_id FROM sph_counter WHERE counter_id='viewpoint' and server_id='$HOSTNAME'
        sql_range_step          = 50000

sql_query = SELECT \
        gi.gridimage_id, \
        gi.title, gi.realname, gi.comment, gi.imageclass, gi.tags, CONCAT('user',gi.user_id) as user, \
        IF(gi.moderation_status='accepted','supplemental',gi.moderation_status) AS status,\
        SUBSTRING(gi.grid_reference,1,LENGTH(gi.grid_reference)-4) AS myriad,\
        CONCAT(SUBSTRING(gi.grid_reference,1,LENGTH(gi.grid_reference)-3),SUBSTRING(gi.grid_reference,LENGTH(gi.grid_reference)-1,1)) AS hectad,\
        gi.grid_reference,\
\
        RADIANS(wgs84_lat) AS wgs84_lat,\
        RADIANS(wgs84_long) AS wgs84_long,\
	natgrlen,\
\
	RADIANS(vlat) AS vlat,\
	RADIANS(vlong) AS vlong,\
	g2.viewpoint_grlen as vgrlen,\
\
        IF(natnorthings>0 AND viewpoint_eastings>0,\
                pow(2,floor(log2(SQRT(\
                        pow(cast(nateastings as signed)-cast(viewpoint_eastings as signed),2)\
                        +pow(cast(natnorthings as signed)-cast(viewpoint_northings as signed),2)\
                ))))\
                ,-1) AS distance,\
        view_direction AS direction,\
\
        sequence, \
        SUBSTRING(MD5(CONCAT(gi.gridimage_id,gi.user_id,'secret-hash')),1,8) AS hash \
FROM gridimage_search gi\
        INNER JOIN gridimage g2 USING (gridimage_id)\
WHERE gi.gridimage_id>=\$start AND gi.gridimage_id<=\$end\
	AND viewpoint_eastings > 0

sql_field_string	= title
sql_field_string	= grid_reference
sql_field_string        = realname

sql_attr_float          = wgs84_lat
sql_attr_float          = wgs84_long
##sql_attr_uint           = ssquare
##	(gi.reference_index * 1000000 + (g2.natnorthings DIV 1000) * 1000 + g2.nateastings DIV 1000) AS ssquare,\
##sql_attr_uint           = scenti
##        (gi.reference_index * 1000000000 + IF(g2.natgrlen+0 <= 3,(g2.nateastings DIV 100) * 100000 + (g2.natnorthings DIV 100),0)) AS scenti,\
sql_attr_uint           = natgrlen

sql_attr_float          = vlat
sql_attr_float          = vlong
##sql_attr_uint           = vsquare
##        (gi.reference_index * 1000000 + (viewpoint_northings DIV 1000) * 1000 + viewpoint_eastings DIV 1000) AS vsquare,\
##sql_attr_uint           = vcenti
##	(gi.reference_index * 1000000000 + IF(g2.viewpoint_grlen+0 <= 3,(g2.viewpoint_eastings DIV 100) * 100000 + (viewpoint_northings DIV 100),0)) AS vcenti,\
sql_attr_uint           = vgrlen

sql_attr_bigint         = distance    #bigint needed for signed!
sql_attr_bigint         = direction

sql_attr_uint           = sequence
sql_field_string        = hash

}
source viewpoint_delta : viewpoint
{
        sql_query_pre           = SET CHARACTER SET 'utf8'
        sql_query_pre           = SET SESSION query_cache_type=OFF

        sql_query_pre           = SELECT GET_LOCK(CONCAT('viewpoint',DATABASE()),30)

        sql_query_range         = SELECT max_doc_id+1,(SELECT MAX(gridimage_id) FROM gridimage_search)+1 FROM sph_counter WHERE counter_id='viewpoint' and server_id='$HOSTNAME'
        sql_range_step          = 500

        sql_query_post          = SELECT RELEASE_LOCK(CONCAT('viewpoint',DATABASE()))
}

#################

index viewpoint_master
{
        type                    = plain
        source                  = viewpoint_master
        path                    = /var/lib/manticore/data/viewpoint_master
        docinfo                 = none
}

index viewpoint_main
{
        type                    = plain
        source                  = viewpoint_main
        path                    = /var/lib/manticore/data/viewpoint_main

        min_word_len            = 1

        morphology              = stem_en
}

index viewpoint_delta : viewpoint_main
{
        source                  = viewpoint_delta
        path                    = /var/lib/manticore/data/viewpoint_delta
}

############################################
# a distributed index with same name as original single index, so queries dont change!

index viewpoint {
        type = distributed
        local = viewpoint_main
        local = viewpoint_delta
}


EOF

